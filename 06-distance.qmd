# Distance-based methods {#distance-methods}

## Local outlier factors

A popular way of using $k$-nearest neighbours for anomaly detection is via local outlier factors [@lof]. This is similar to the idea discussed in \@ref(kdescores) of finding points with low probability density estimates, in that it is designed to find points in areas with few surrounding observations.

Suppose we write the distance between observations $\bm{y}_i$ and $\bm{y}_j$ as $\|\bm{y}_i - \bm{y}_j\|$, and let $d_{i,k}$ be the distance between observation $\bm{y}_i$ and its $k$th nearest neighbour.

Let $N_{i,k}$ be the set of $k$ nearest neighbours within $d_{i,k}$ of $\bm{y}_i$. (If there are multiple observations all exactly $d_{i,k}$ from $\bm{y}_i$, then $N_{i,k}$ may contain more than $k$ observations, but we will ignore that issue here.)

Note that an observation $\bm{y}_j$ may be within $N_{i,k}$ while $\bm{y}_i$ does not fall within $N_{j,k}$, as shown in the diagram below.

```{r njk, fig.cap="A synthetic data set of 11 observations. Nearest neighbourhoods containing five observations each are shown for $\\bm{y}_1$ (in orange) and $\\bm{y}_2$ (in blue). The neighbourhood of $\\bm{y}_1$ contains $\\bm{y}_2$ in its nearest five observations, but $\\bm{y}_2$ does not include $\\bm{y}_1$ in its nearest five observations.", echo=FALSE, warning=FALSE}
set.seed(2)
df <- tibble(
  x = c(rnorm(5), rnorm(6, 5, 1)),
  y = c(rnorm(5), rnorm(6, 5, 1))
)
chosen <- c(3, 11)
knn <- dbscan::kNN(df, 5)$id[chosen, ]
df <- df %>%
  mutate(
    d = dbscan::kNNdist(df, 5),
    n15 = if_else(row_number() %in% knn[1, ], "N15", "NO"),
    n25 = if_else(row_number() %in% knn[2, ], "N25", "NO")
  )
df %>%
  ggplot() +
  ggforce::geom_circle(aes(x0 = x, y0 = y, r = d, col = c("N15", "N25"), fill = c("N15", "N25")),
    alpha = 0.2, data = df[chosen, ]
  ) +
  geom_point(aes(x = x, y = y), size = 3) +
  # geom_point(aes(x=x, y=y), size=3, data=df[chosen,], col=cols) +
  annotate("text",
    x = df$x[chosen] + 0.3, y = df$y[chosen] + 0.3,
    label = latex2exp::TeX(paste0("$y_", 1:2, "$"), bold = TRUE), col = discrete_colors[1:2]
  ) +
  annotate("text",
    x = c(-0.5, 3.6), y = c(4.2, 6),
    label = latex2exp::TeX(paste0("$N_{", 1:2, ",5}$")), col = discrete_colors[1:2]
  ) +
  geom_segment(aes(x = x, y = y, xend = c(7.75, 8.75), yend = y),
    arrow = arrow(length = unit(0.02, "npc")),
    data = df[chosen, ], col = discrete_colors[1:2]
  ) +
  annotate("text",
    x = c(4.7, 7), y = c(-0.8, 4.1),
    label = latex2exp::TeX(paste0("$d_{", 1:2, ",5}$")), col = discrete_colors[1:2]
  ) +
  coord_fixed(xlim = c(-4, 8.5), ylim = range(df$y)) +
  guides(col = "none", fill = "none") +
  theme_void()
```

Let $r_k(i,j) = \max(d_{j,k}, \|\bm{y}_i-\bm{y}_j\|)$ be the "reachability" of $\bm{y}_i$ from $\bm{y}_j$. Thus, $r_k(i,j)$ is the distance between observations $\bm{y}_i$ and $\bm{y}_j$ when they are far from each other, but is equal to $d_{j,k}$ if $\bm{y}_i$ is one of the $k$ nearest neighbours of $\bm{y}_j$. The reachability is a truncated variant of the usual Euclidean distance $\|\bm{y}_i-\bm{y}_j\|$ so that it is not less than $d_{j,k}$.

The average reachability of $\bm{y}_i$ *from* its nearest neighbours is given by
$$
  \bar{r}_{i,k} = k^{-1} \sum_{\bm{y}_j \in N_{i,k}} r_k(i,j)
$$
This is not the same as the average reachability of the neighbours *from* $\bm{y}_i$ which, by definition, would be $d_{i,k}$. An observation will have high average reachability if it is far from its neighbours, whereas it will have low average reachability if it has many close neighbours.

Then the local outlier factor for observation $\bm{y}_i$ is given by
$$
\ell_{i,k} = \frac{\bar{r}_{i,k}}{k}\sum_{\bm{y}_j \in N_{i,k}} \bar{r}^{-1}_{j,k}.
$$
Thus, it is the ratio between $\bar{r}_{i,k}$ and the average value of $\bar{r}^{-1}_{j,k}$ for points within its neighbourhood.

This provides a relative measure of the density of each observation compared to its neighbours. An observation is regarded as an anomaly if it is in a low-density region (far from its neighbours) while its neighbours are in higher density regions (with many neighbours nearby). A value of $\ell_{i,k}$ much greater than 1 shows that the observation has much larger average reachability compared to its neighbours, and so is regarded as an anomaly.

One problem with this definition is that $\ell_{i,k}$ can be infinite. If the data set contains at least $k+1$ identical observations, then the average reachability $\bar{r}_k(j,k)$ will be 0 if $\bm{y}_j$ is one of the group of identical observations. Consequently, $\ell_{i,k} = \infty$ if $\bm{y}_i$ is a neighbour to one of the group of identical observations.  In this book we use a slightly different definition from that used elsewhere and replace these infinite values with zeros.

Another problem is that it can be difficult to determine an appropriate value for $k$.

### Example: Old Faithful data

```{r}
of_scores <- oldfaithful %>%
  mutate(lof = lof_scores(duration, k = 150))
of_scores %>% arrange(desc(lof))
of_scores %>%
  filter(duration < 7000) %>%
  ggplot(aes(x = duration, y = lof)) +
  geom_point()
```

Again, the two large scores correspond to the extreme 2 hour duration and the tiny 1 second duration. The value of $k=150$ has been chosen by trial and error.
